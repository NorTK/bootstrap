---
# This playbook bootstrap a fresh AlmaLinux 10 system.
#
# Usage:
#   ansible-playbook -i inventory bootstrap.yaml
#
# Iv√°n Chavero <ivan@nortk.com>
#

- name: Configure AlmaLinux 10 Systems
  hosts: almalinux
  user: root
  become: yes
  vars:
    tpm_repo_url: "https://github.com/tmux-plugins/tpm"
    tpm_install_path: "{{ ansible_user_dir }}/.tmux/plugins/tpm"
  tasks:

    - name: Ensure the crb repository is enabled
      community.general.dnf_config_manager:
        name: crb
        state: enabled

    - name: Install EPEL
      ansible.builtin.dnf:
        name: epel-release

    - name: Install required packages
      ansible.builtin.dnf:
        name:
            - fail2ban
            - tmux
            - git
            - podman
        state: present

    - name: Copy nortk_env.sh to /etc/profile.d/
      ansible.builtin.copy:
        src: files/nortk_env.sh   # Path to the file on the Ansible control node
        dest: /etc/profile.d/nortk_env.sh # Destination on the target server
        owner: root
        group: root
        mode: '0755'

    - name: Ensure .tmux plugins directory exists for the connecting user
      ansible.builtin.file:
        path: "{{ ansible_user_dir }}/.tmux/plugins"
        state: directory
        mode: '0755'

    - name: Install tpm (Tmux Plugin Manager)
      ansible.builtin.git:
        repo: "{{ tpm_repo_url }}"
        dest: "{{ tpm_install_path }}"
        clone: yes
        update: yes

    - name: Copy tmux.conf
      ansible.builtin.copy:
        src: files/tmux.conf
        dest: "{{ ansible_user_dir }}/.tmux.conf"
        owner: root
        group: root
        mode: '0755'

    - name: Copy Fail2Ban local configuration
      ansible.builtin.copy:
        src: files/jail.local
        dest: /etc/fail2ban/jail.local
        owner: root
        group: root
        mode: '0644'

    - name: Ensure Fail2Ban service is enabled and running
      ansible.builtin.service:
        name: fail2ban
        enabled: yes
        state: restarted
